"use strict";!function(t){const s=Symbol(),e=0,a=1,i=2,c=3,o=4,r=5,h=6,n=7,l=8,d=9,g=11,b=12,p=13,f=14,v=15,m=16,w=17,x=18,u=19,y=20,k=21,P=1,z=2,T=function(t,s){return t[s]<<8|t[s+1]},R=function(t,s){const e=T(t,s);return e<32768?e:e-65536},X={x:0,y:0,z:0,dx:0,dy:0,dz:0,m:[[0,0,0,0],[0,0,0,0],[0,0,0,0]],setup:function(t,s,e){this.dx=t[3],this.dy=t[4],this.dz=t[5];const a=Math,i=t[0]-s,c=t[1],o=t[2],r=t[6]/180*a.PI,h=t[7]/180*a.PI,n=t[8]/180*a.PI,l=a.cos(r),d=a.cos(h),g=a.cos(n),b=a.sin(r),p=a.sin(h),f=a.sin(n),v=this.m;v[0][0]=b*p*f+l*g,v[0][1]=f*d,v[0][2]=l*p*f-b*g,v[0][3]=this.dx+i,v[1][0]=b*p*g-f*l,v[1][1]=d*g,v[1][2]=l*p*g+b*f,v[1][3]=this.dy+c,v[2][0]=b*d,v[2][1]=-p,v[2][2]=l*d,v[2][3]=this.dz+o+e},convert:function(t,s,e){var a=t-this.dx,i=s-this.dy,c=e-this.dz,o=this.m;this.x=o[0][0]*a+o[0][1]*i+o[0][2]*c+o[0][3],this.y=o[1][0]*a+o[1][1]*i+o[1][2]*c+o[1][3],this.z=o[2][0]*a+o[2][1]*i+o[2][2]*c+o[2][3]}},Y={x:0,y:0,z:0,m:[[0,0,0],[0,0,0],[0,0,0]],setup:function(t,s,e){const a=Math,i=s/180*a.PI*(e<0?-1:1),c=(e+90)/180*a.PI*(e<0?1:-1),o=t/180*a.PI,r=a.cos(i),h=a.cos(c),n=a.cos(o),l=a.sin(i),d=a.sin(c),g=a.sin(o),b=this.m;b[0][0]=-l*d*g+r*n,b[0][1]=-l*h,b[0][2]=l*d*n+r*g,b[1][0]=r*d*g+l*n,b[1][1]=r*h,b[1][2]=-r*d*n+l*g,b[2][0]=-h*g,b[2][1]=d,b[2][2]=h*n},convert:function(t,s,e){var a=this.m;this.x=a[0][0]*t+a[0][1]*s+a[0][2]*e,this.y=a[1][0]*t+a[1][1]*s+a[1][2]*e,this.z=a[2][0]*t+a[2][1]*s+a[2][2]*e}};t.Magic2=class{constructor(t){this[s]={window:{x:0,y:0,w:0,h:0},orientation:{alpha:0,beta:0,gamma:-90,baseAlpha:void 0},depth:{minz:50,maxz:2e3},cext:!1,color:15,parameters:[0,0,0,0,0,0,0,0,0],data:{pct:0,vertices:new Int16Array(24576),lct:0,indices:new Uint16Array(16384),color:0},translate:{vertices:new Float32Array(24576),indices:new Float32Array(16384)},palette:[{r:0,g:0,b:0,c:"rgba(  0,   0,   0, 1.0)"},{r:85,g:85,b:85,c:"rgba( 85,  85,  85, 1.0)"},{r:0,g:0,b:127,c:"rgba(  0,   0, 127, 1.0)"},{r:0,g:0,b:255,c:"rgba(  0,   0, 255, 1.0)"},{r:127,g:0,b:0,c:"rgba(127,   0,   0, 1.0)"},{r:255,g:0,b:0,c:"rgba(255,   0,   0, 1.0)"},{r:127,g:0,b:127,c:"rgba(127,   0, 127, 1.0)"},{r:255,g:0,b:255,c:"rgba(255,   0, 255, 1.0)"},{r:0,g:127,b:0,c:"rgba(  0, 127,   0, 1.0)"},{r:0,g:255,b:0,c:"rgba(  0, 255,   0, 1.0)"},{r:0,g:127,b:127,c:"rgba(  0, 127, 127, 1.0)"},{r:0,g:255,b:255,c:"rgba(  0, 255, 255, 1.0)"},{r:127,g:127,b:0,c:"rgba(127, 127,   0, 1.0)"},{r:255,g:255,b:0,c:"rgba(255, 255,   0, 1.0)"},{r:170,g:170,b:170,c:"rgba(170, 170, 170, 1.0)"},{r:255,g:255,b:255,c:"rgba(255, 255, 255, 1.0)"}],contexts:t,fgcontext:0,bgcontext:1,clients:[],apage:0,vr:0,updatePalette:function(t){const e=this[s].palette[t];e.c="rgba("+e.r+","+e.g+","+e.b+",1.0)",e.l=.299*e.r+.587*e.g+.114*e.b|0,e.cl="rgba("+e.l+",0,0,1.0)",e.cr="rgba(0,0,"+e.l+",1.0)"}.bind(this),draw:function(t){var e,a=this[s].data.vertices,i=3*this[s].data.pct,c=this[s].translate.vertices;for(X.setup(this[s].parameters,t.position,this[s].depth.minz),e=0;e<i;e+=3)X.convert(a[e+0],a[e+1],a[e+2]),c[e+0]=X.x,c[e+1]=X.y,c[e+2]=X.z;if(this.vr()){var o=this[s].orientation;for(Y.setup(o.alpha+t.alpha,o.beta,o.gamma),e=0;e<i;e+=3)Y.convert(c[e+0],c[e+1],c[e+2]),c[e+0]=Y.x,c[e+1]=Y.y,c[e+2]=Y.z}var r=this[s].depth.maxz+this[s].depth.minz;for(e=0;e<i;e+=3){var h=c[e+2];if(!(h<=0||r<h)){var n=h/256;c[e+0]/=n,c[e+1]/=n}}var l=this[s].data.indices,d=2*this[s].data.lct,g=this[s].contexts[this[s].bgcontext];g.save(),g.beginPath(),g.rect(t.base,0,t.width,g.canvas.height),g.clip(),g.closePath(),g.beginPath(),g.strokeStyle=this[s].palette[this[s].data.color][t.color];var b=256*t.scaleX,p=256*t.scaleY,f=t.base+t.width/2,v=p/2,m=b/256,w=p/256;for(e=0;e<d;e+=2){var x=3*l[e+0],u=3*l[e+1],y=c[x+2],k=c[u+2];y<=0||r<y||k<=0||r<k||(g.moveTo(f+c[x+0]*m,v+c[x+1]*w),g.lineTo(f+c[u+0]*m,v+c[u+1]*w))}g.closePath(),g.stroke(),g.restore()}.bind(this)};const e=this[s].contexts[this[s].fgcontext];e.canvas.style.display="block",this[s].contexts[this[s].bgcontext].canvas.style.display="none";for(let t of this[s].contexts)t.clearRect(0,0,e.canvas.width,e.canvas.height),t.globalCompositeOperation="lighter"}palette(t,e){if(void 0==e)return this[s].palette[t];var a=0==(1&e)?0:4,i=((e>>6&31)<<3)+a,c=((e>>11&31)<<3)+a,o=((e>>1&31)<<3)+a,r=this[s].palette[t];r.r=i,r.g=c,r.b=o,this[s].updatePalette(t)}vr(t){if(void 0===t)return this[s].vr;var e=this[s].vr;this[s].vr=t;for(let t=0;t<16;++t)this[s].updatePalette(t);return e}orientation(t,e,a){const i=this[s].orientation;void 0===i.baseAlpha&&(i.baseAlpha=t),i.alpha=t-i.baseAlpha,i.beta=e,i.gamma=a}context(t){const e=this[s].vr==P,a=this[s].contexts[0].canvas,i=e&&2==t?a.width/2:0,c=e&&0!=t?a.width/2:a.width,o=e&&0!=t?1:4/3;return{color:this[s].vr!=z?"c":1==t?"cl":"cr",base:i,width:c,offset:i+(c-a.height*o)/2,position:0==t?0:1==t?-10:10,alpha:0==t?0:1==t?-2:2,aspect:o,scaleX:a.height/256*o,scaleY:a.height/256}}vsync(t){this[s].clients.push(t)}line(t,e){const a=this[s].contexts[this[s].apage],i=t.length;if(this[s].vr){const c=this.context(1);a.strokeStyle=this[s].palette[this[s].color][c.color],a.beginPath(),a.moveTo(t[0]*c.scaleX+c.offset,e[0]*c.scaleY);for(let s=1;s<i;++s)a.lineTo(t[s]*c.scaleX+c.offset,e[s]*c.scaleY);a.stroke();const o=this.context(2);a.strokeStyle=this[s].palette[this[s].color][o.color],a.beginPath(),a.moveTo(t[0]*o.scaleX+o.offset,e[0]*o.scaleY);for(let s=1;s<i;++s)a.lineTo(t[s]*o.scaleX+o.offset,e[s]*o.scaleY);a.stroke()}else{const c=this.context(0);a.strokeStyle=this[s].palette[this[s].color][c.color],a.beginPath(),a.moveTo(t[0]*c.scaleX+c.offset,e[0]*c.scaleY);for(let s=1;s<i;++s)a.lineTo(t[s]*c.scaleX+c.offset,e[s]*c.scaleY);a.stroke()}}boxFull(t,e,a,i){const c=Math.min(t,a),o=Math.min(e,i),r=Math.abs(a-t),h=Math.abs(i-e),n=this[s].contexts[this[s].apage];if(this[s].vr){const t=this.context(1);n.fillStyle=this[s].palette[this[s].color][t.color],n.fillRect(c*t.scaleX+t.offset,o*t.scaleY,r*t.scaleX,h*t.scaleY);const e=this.context(2);n.fillStyle=this[s].palette[this[s].color][e.color],n.fillRect(c*e.scaleX+e.offset,o*e.scaleY,r*e.scaleX,h*e.scaleY)}else{const t=this.context(0);n.fillStyle=this[s].palette[this[s].color][t.color],n.fillRect(c*t.scaleX+t.offset,o*t.scaleY,r*t.scaleX,h*t.scaleY)}}setWindow(t,e,a,i){this[s].window.x=t,this[s].window.y=e,this[s].window.w=a-t,this[s].window.h=i-e}cls(){const t=this[s].contexts[this[s].apage];t.clearRect(0,0,t.canvas.width,t.canvas.height)}set3dParameter(t,e){this[s].parameters[t]=e}set3dData(t,e,a,i,c){this[s].data.pct=t,this[s].data.vertices=e,this[s].data.lct=a,this[s].data.indices=i,this[s].data.color=void 0!==c?c:this[s].color}set3dRawData(t,e){const a=e;this[s].data.pct=T(t,e),e+=2;for(let a=0;a<this[s].data.pct;++a)this[s].data.vertices[3*a+0]=R(t,e+0),this[s].data.vertices[3*a+1]=R(t,e+2),this[s].data.vertices[3*a+2]=R(t,e+4),e+=6;this[s].data.lct=T(t,e),e+=2,this[s].cext?(this[s].data.color=15&T(t,e),e+=2):this[s].data.color=this[s].color;for(let a=0;a<this[s].data.lct;++a)this[s].data.indices[2*a+0]=T(t,e+0),this[s].data.indices[2*a+1]=T(t,e+2),e+=4;return e-a}translate3dTo2d(){this[s].vr?(this[s].draw(this.context(1)),this[s].draw(this.context(2))):this[s].draw(this.context(0))}display2d(){const t=this[s].fgcontext;this[s].fgcontext=this[s].bgcontext,this[s].bgcontext=t;const e=this[s].contexts[this[s].fgcontext],a=this[s].contexts[this[s].bgcontext];if(this[s].vr){var i=this.context(1),c=this.context(2);for(var o of this[s].clients)o(e,i),o(e,c);a.clearRect(0,0,a.canvas.width,a.canvas.height),a.fillStyle=this[s].palette[0][i.color],a.fillRect(0,0,a.canvas.width,a.canvas.height),a.fillStyle=this[s].palette[0][c.color],a.fillRect(0,0,a.canvas.width,a.canvas.height)}else{var r=this.context(0);for(var o of this[s].clients)o(e,r);a.clearRect(0,0,a.canvas.width,a.canvas.height),a.fillStyle=this[s].palette[0][r.color],a.fillRect(0,0,a.canvas.width,a.canvas.height)}e.canvas.style.display="block",a.canvas.style.display="none"}color(t){this[s].color=t}crt(t){console.warn("magic2: partially ignoring command CRT, "+t),this[s].cext=0!=(256&t)}auto(t,s){let P=!1;for(;;){var z=T(t,s);switch(s+=2,z){case e:{const e=T(t,s+0),a=[],i=[];for(let c=0;c<e;++c)a.push(T(t,s+2+4*c)),i.push(T(t,s+4+4*c));s+=2+4*e,this.line(a,i);break}case a:throw new Error("magic2: unsupported command SPLINE");case i:throw s+=8,new Error("magic2: unsupported command BOX");case c:throw new Error("magic2: unsupported command TRIANGLE");case o:{const e=T(t,s+0),a=T(t,s+2),i=T(t,s+4),c=T(t,s+6);s+=8,this.boxFull(e,a,i,c);break}case r:throw new Error("magic2: unsupported command CIRCLE_FULL");case h:{const e=T(t,s+0),a=T(t,s+2),i=T(t,s+4),c=T(t,s+6);s+=8,this.setWindow(e,a,i,c);break}case n:{const e=T(t,s);s+=2,console.warn("magic2: ignoring command SET_MODE, "+e);break}case l:throw new Error("magic2: unsupported command POINT");case d:this.cls();break;case g:{const e=T(t,s+0),a=R(t,s+2);s+=4,this.set3dParameter(e,a);break}case b:s+=this.set3dRawData(t,s);break;case p:this.translate3dTo2d();break;case f:this.display2d(),P=!0;break;case v:return P;case m:{const e=T(t,s);s+=2,this.color(e);break}case w:{const e=T(t,s);s+=2,this.crt(e);break}case x:break;case u:throw new Error("magic2: AUTO should not be used inside AUTO");case y:{const e=T(t,s);s+=2,this.apage(e);break}case k:{const e=T(t,s+0),a=T(t,s+2);s+=4,this.depth(e,a);break}default:throw new Error("magic2: unknown command "+z)}}}apage(t){this[s].apage=t}depth(t,e){this[s].depth.minz=t,this[s].depth.maxz=e}}}("undefined"!=typeof global?global:"undefined"!=typeof module?module.exports:window);