"use strict";function _classCallCheck(t,a){if(!(t instanceof a))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,a){for(var e=0;e<a.length;e++){var s=a[e];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(a,e,s){return e&&t(a.prototype,e),s&&t(a,s),a}}();!function(t){var a=Symbol(),e=0,s=1,i=2,r=3,o=4,c=5,n=6,h=7,l=8,v=9,d=11,u=12,f=13,b=14,g=15,p=16,y=17,m=18,w=19,x=20,k=21,P=0,T=1,z=2,X=3,Y=4,E=5,S=6,A=7,C=8,I=1,R=2,M=function(t,a){return t[a]<<8|t[a+1]},O=function(t,a){var e=M(t,a);return e<32768?e:e-65536},_={x:0,y:0,z:0,dx:0,dy:0,dz:0,m:[[0,0,0,0],[0,0,0,0],[0,0,0,0]],setup:function(t,a,e){this.dx=t[X],this.dy=t[Y],this.dz=t[E];var s=Math,i=t[P]-a,r=t[T],o=t[z],c=t[S]/180*s.PI,n=t[A]/180*s.PI,h=t[C]/180*s.PI,l=s.cos(c),v=s.cos(n),d=s.cos(h),u=s.sin(c),f=s.sin(n),b=s.sin(h),g=this.m;g[0][0]=u*f*b+l*d,g[0][1]=b*v,g[0][2]=l*f*b-u*d,g[0][3]=this.dx+i,g[1][0]=u*f*d-b*l,g[1][1]=v*d,g[1][2]=l*f*d+u*b,g[1][3]=this.dy+r,g[2][0]=u*v,g[2][1]=-f,g[2][2]=l*v,g[2][3]=this.dz+o+e},convert:function(t,a,e){var s=t-this.dx,i=a-this.dy,r=e-this.dz,o=this.m;this.x=o[0][0]*s+o[0][1]*i+o[0][2]*r+o[0][3],this.y=o[1][0]*s+o[1][1]*i+o[1][2]*r+o[1][3],this.z=o[2][0]*s+o[2][1]*i+o[2][2]*r+o[2][3]}},F={x:0,y:0,z:0,m:[[0,0,0],[0,0,0],[0,0,0]],setup:function(t,a,e){var s=Math,i=a/180*s.PI*(e<0?-1:1),r=(e+90)/180*s.PI*(e<0?1:-1),o=t/180*s.PI,c=s.cos(i),n=s.cos(r),h=s.cos(o),l=s.sin(i),v=s.sin(r),d=s.sin(o),u=this.m;u[0][0]=-l*v*d+c*h,u[0][1]=-l*n,u[0][2]=l*v*h+c*d,u[1][0]=c*v*d+l*h,u[1][1]=c*n,u[1][2]=-c*v*h+l*d,u[2][0]=-n*d,u[2][1]=v,u[2][2]=n*h},convert:function(t,a,e){var s=this.m;this.x=s[0][0]*t+s[0][1]*a+s[0][2]*e,this.y=s[1][0]*t+s[1][1]*a+s[1][2]*e,this.z=s[2][0]*t+s[2][1]*a+s[2][2]*e}},L=function(){function t(e){_classCallCheck(this,t),this[a]={window:{x:0,y:0,w:0,h:0},orientation:{alpha:0,beta:0,gamma:-90,baseAlpha:void 0},depth:{minz:50,maxz:2e3},cext:!1,color:15,parameters:[0,0,0,0,0,0,0,0,0],data:{pct:0,vertices:new Int16Array(24576),lct:0,indices:new Uint16Array(16384),color:0},translate:{vertices:new Float32Array(24576),indices:new Float32Array(16384)},palette:[{r:0,g:0,b:0,c:"rgba(  0,   0,   0, 1.0)"},{r:85,g:85,b:85,c:"rgba( 85,  85,  85, 1.0)"},{r:0,g:0,b:127,c:"rgba(  0,   0, 127, 1.0)"},{r:0,g:0,b:255,c:"rgba(  0,   0, 255, 1.0)"},{r:127,g:0,b:0,c:"rgba(127,   0,   0, 1.0)"},{r:255,g:0,b:0,c:"rgba(255,   0,   0, 1.0)"},{r:127,g:0,b:127,c:"rgba(127,   0, 127, 1.0)"},{r:255,g:0,b:255,c:"rgba(255,   0, 255, 1.0)"},{r:0,g:127,b:0,c:"rgba(  0, 127,   0, 1.0)"},{r:0,g:255,b:0,c:"rgba(  0, 255,   0, 1.0)"},{r:0,g:127,b:127,c:"rgba(  0, 127, 127, 1.0)"},{r:0,g:255,b:255,c:"rgba(  0, 255, 255, 1.0)"},{r:127,g:127,b:0,c:"rgba(127, 127,   0, 1.0)"},{r:255,g:255,b:0,c:"rgba(255, 255,   0, 1.0)"},{r:170,g:170,b:170,c:"rgba(170, 170, 170, 1.0)"},{r:255,g:255,b:255,c:"rgba(255, 255, 255, 1.0)"}],contexts:e,fgcontext:0,bgcontext:1,clients:[],apage:0,vr:0,updatePalette:function(t){var e=this[a].palette[t];e.c="rgba("+e.r+","+e.g+","+e.b+",1.0)",e.l=.299*e.r+.587*e.g+.114*e.b|0,e.cl="rgba("+e.l+",0,0,1.0)",e.cr="rgba(0,0,"+e.l+",1.0)"}.bind(this),draw:function(t){var e=this[a].data.vertices,s=3*this[a].data.pct,i=this[a].translate.vertices;_.setup(this[a].parameters,t.position,this[a].depth.minz);var r;for(r=0;r<s;r+=3)_.convert(e[r+0],e[r+1],e[r+2]),i[r+0]=_.x,i[r+1]=_.y,i[r+2]=_.z;if(this.vr()){var o=this[a].orientation;for(F.setup(o.alpha+t.alpha,o.beta,o.gamma),r=0;r<s;r+=3)F.convert(i[r+0],i[r+1],i[r+2]),i[r+0]=F.x,i[r+1]=F.y,i[r+2]=F.z}var c=this[a].depth.maxz;for(r=0;r<s;r+=3){var n=i[r+2];if(!(n<=0||c<n)){var h=n/256;i[r+0]/=h,i[r+1]/=h}}var l=this[a].data.indices,v=2*this[a].data.lct,d=this[a].contexts[this[a].bgcontext];d.save(),d.beginPath(),d.rect(t.base,0,t.width,d.canvas.height),d.clip(),d.closePath(),d.beginPath(),d.strokeStyle=this[a].palette[this[a].data.color][t.color];var u=256*t.scaleX,f=256*t.scaleY,b=t.base+t.width/2,g=f/2,p=u/256,y=f/256;for(r=0;r<v;r+=2){var m=3*l[r+0],w=3*l[r+1],x=i[m+2],k=i[w+2];x<=0||c<x||k<=0||c<k||(d.moveTo(b+i[m+0]*p,g+i[m+1]*y),d.lineTo(b+i[w+0]*p,g+i[w+1]*y))}d.closePath(),d.stroke(),d.restore()}.bind(this)};var s=this[a].contexts[this[a].fgcontext];s.canvas.style.display="block";var i=this[a].contexts[this[a].bgcontext];i.canvas.style.display="none";var r=!0,o=!1,c=void 0;try{for(var n,h=this[a].contexts[Symbol.iterator]();!(r=(n=h.next()).done);r=!0){var l=n.value;l.clearRect(0,0,s.canvas.width,s.canvas.height),l.globalCompositeOperation="lighter"}}catch(t){o=!0,c=t}finally{try{!r&&h.return&&h.return()}finally{if(o)throw c}}}return _createClass(t,[{key:"palette",value:function t(e,s){if(void 0==s)return this[a].palette[e];var i=0==(1&s)?0:4,r=((s>>6&31)<<3)+i,o=((s>>11&31)<<3)+i,c=((s>>1&31)<<3)+i,t=this[a].palette[e];t.r=r,t.g=o,t.b=c,this[a].updatePalette(e)}},{key:"vr",value:function(t){if(void 0===t)return this[a].vr;var e=this[a].vr;this[a].vr=t;for(var s=0;s<16;++s)this[a].updatePalette(s);return e}},{key:"orientation",value:function t(e,s,i){var t=this[a].orientation;void 0===t.baseAlpha&&(t.baseAlpha=e),t.alpha=e-t.baseAlpha,t.beta=s,t.gamma=i}},{key:"context",value:function(t){var e=this[a].vr==I,s=this[a].contexts[0].canvas,i=e&&2==t?s.width/2:0,r=e&&0!=t?s.width/2:s.width,o=e&&0!=t?1:4/3,c=this[a].vr!=R?"c":1==t?"cl":"cr";return{color:c,base:i,width:r,offset:i+(r-s.height*o)/2,position:0==t?0:1==t?-10:10,alpha:0==t?0:1==t?-2:2,aspect:o,scaleX:s.height/256*o,scaleY:s.height/256}}},{key:"vsync",value:function(t){this[a].clients.push(t)}},{key:"line",value:function(t,e){var s=this[a].contexts[this[a].apage],i=t.length;if(this[a].vr){var r=this.context(1);s.strokeStyle=this[a].palette[this[a].color][r.color],s.beginPath(),s.moveTo(t[0]*r.scaleX+r.offset,e[0]*r.scaleY);for(var o=1;o<i;++o)s.lineTo(t[o]*r.scaleX+r.offset,e[o]*r.scaleY);s.stroke();var c=this.context(2);s.strokeStyle=this[a].palette[this[a].color][c.color],s.beginPath(),s.moveTo(t[0]*c.scaleX+c.offset,e[0]*c.scaleY);for(var n=1;n<i;++n)s.lineTo(t[n]*c.scaleX+c.offset,e[n]*c.scaleY);s.stroke()}else{var h=this.context(0);s.strokeStyle=this[a].palette[this[a].color][h.color],s.beginPath(),s.moveTo(t[0]*h.scaleX+h.offset,e[0]*h.scaleY);for(var l=1;l<i;++l)s.lineTo(t[l]*h.scaleX+h.offset,e[l]*h.scaleY);s.stroke()}}},{key:"boxFull",value:function(t,e,s,i){var r=Math.min(t,s),o=Math.min(e,i),c=Math.abs(s-t),n=Math.abs(i-e),h=this[a].contexts[this[a].apage];if(this[a].vr){var l=this.context(1);h.fillStyle=this[a].palette[this[a].color][l.color],h.fillRect(r*l.scaleX+l.offset,o*l.scaleY,c*l.scaleX,n*l.scaleY);var v=this.context(2);h.fillStyle=this[a].palette[this[a].color][v.color],h.fillRect(r*v.scaleX+v.offset,o*v.scaleY,c*v.scaleX,n*v.scaleY)}else{var d=this.context(0);h.fillStyle=this[a].palette[this[a].color][d.color],h.fillRect(r*d.scaleX+d.offset,o*d.scaleY,c*d.scaleX,n*d.scaleY)}}},{key:"setWindow",value:function(t,e,s,i){this[a].window.x=t,this[a].window.y=e,this[a].window.w=s-t,this[a].window.h=i-e}},{key:"cls",value:function(){var t=this[a].contexts[this[a].apage];t.clearRect(0,0,t.canvas.width,t.canvas.height)}},{key:"set3dParameter",value:function(t,e){this[a].parameters[t]=e}},{key:"set3dData",value:function(t,e,s,i,r){this[a].data.pct=t,this[a].data.vertices=e,this[a].data.lct=s,this[a].data.indices=i,this[a].data.color=void 0!==r?r:this[a].color}},{key:"set3dRawData",value:function(t,e){var s=e;this[a].data.pct=M(t,e),e+=2;for(var i=0;i<this[a].data.pct;++i)this[a].data.vertices[3*i+0]=O(t,e+0),this[a].data.vertices[3*i+1]=O(t,e+2),this[a].data.vertices[3*i+2]=O(t,e+4),e+=6;this[a].data.lct=M(t,e),e+=2,this[a].cext?(this[a].data.color=15&M(t,e),e+=2):this[a].data.color=this[a].color;for(var r=0;r<this[a].data.lct;++r)this[a].data.indices[2*r+0]=M(t,e+0),this[a].data.indices[2*r+1]=M(t,e+2),e+=4;return e-s}},{key:"translate3dTo2d",value:function(){this[a].vr?(this[a].draw(this.context(1)),this[a].draw(this.context(2))):this[a].draw(this.context(0))}},{key:"display2d",value:function(){var t=this[a].fgcontext;this[a].fgcontext=this[a].bgcontext,this[a].bgcontext=t;var e=this[a].contexts[this[a].fgcontext];if(this[a].vr){var s=this.context(1),i=this.context(2),r=!0,o=!1,c=void 0;try{for(var n,h=this[a].clients[Symbol.iterator]();!(r=(n=h.next()).done);r=!0){var l=n.value;l(e,s),l(e,i)}}catch(t){o=!0,c=t}finally{try{!r&&h.return&&h.return()}finally{if(o)throw c}}}else{var v=this.context(0),d=!0,u=!1,f=void 0;try{for(var b,g=this[a].clients[Symbol.iterator]();!(d=(b=g.next()).done);d=!0){var l=b.value;l(e,v)}}catch(t){u=!0,f=t}finally{try{!d&&g.return&&g.return()}finally{if(u)throw f}}}e.canvas.style.display="block";var p=this[a].contexts[this[a].bgcontext];p.canvas.style.display="none",p.clearRect(0,0,p.canvas.width,p.canvas.height)}},{key:"color",value:function(t){this[a].color=t}},{key:"crt",value:function(t){console.warn("magic2: partially ignoring command CRT, "+t),this[a].cext=0!=(256&t)}},{key:"auto",value:function(t,a){for(var P=!1;;){var T=M(t,a);switch(a+=2,T){case e:for(var z=M(t,a+0),X=[],Y=[],E=0;E<z;++E)X.push(M(t,a+2+4*E)),Y.push(M(t,a+4+4*E));a+=2+4*z,this.line(X,Y);break;case s:throw new Error("magic2: unsupported command SPLINE");case i:throw a+=8,new Error("magic2: unsupported command BOX");case r:throw new Error("magic2: unsupported command TRIANGLE");case o:var S=M(t,a+0),A=M(t,a+2),C=M(t,a+4),I=M(t,a+6);a+=8,this.boxFull(S,A,C,I);break;case c:throw new Error("magic2: unsupported command CIRCLE_FULL");case n:var R=M(t,a+0),_=M(t,a+2),F=M(t,a+4),L=M(t,a+6);a+=8,this.setWindow(R,_,F,L);break;case h:var D=M(t,a);a+=2,console.warn("magic2: ignoring command SET_MODE, "+D);break;case l:throw new Error("magic2: unsupported command POINT");case v:this.cls();break;case d:var U=M(t,a+0),N=O(t,a+2);a+=4,this.set3dParameter(U,N);break;case u:a+=this.set3dRawData(t,a);break;case f:this.translate3dTo2d();break;case b:this.display2d(),P=!0;break;case g:return P;case p:var W=M(t,a);a+=2,this.color(W);break;case y:var j=M(t,a);a+=2,this.crt(j);break;case m:break;case w:throw new Error("magic2: AUTO should not be used inside AUTO");case x:var B=M(t,a);a+=2,this.apage(B);break;case k:var G=M(t,a+0),q=M(t,a+2);a+=4,this.depth(G,q);break;default:throw new Error("magic2: unknown command "+T)}}}},{key:"apage",value:function(t){this[a].apage=t}},{key:"depth",value:function(t,e){this[a].depth.minz=t,this[a].depth.maxz=e}}]),t}();t.Magic2=L}("undefined"!=typeof global?global:"undefined"!=typeof module?module.exports:window);