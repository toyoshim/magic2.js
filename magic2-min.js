"use strict";function _createForOfIteratorHelper(t,e){var a;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(a=_unsupportedIterableToArray(t))||e&&t&&"number"==typeof t.length){a&&(t=a);var r=0,i=function(){};return{s:i,n:function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,o=!0,n=!1;return{s:function(){a=t[Symbol.iterator]()},n:function(){var t=a.next();return o=t.done,t},e:function(t){n=!0,s=t},f:function(){try{o||null==a.return||a.return()}finally{if(n)throw s}}}}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var a=Object.prototype.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var a=0,r=new Array(e);a<e;a++)r[a]=t[a];return r}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var a=0;a<e.length;a++){var r=e[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function _createClass(t,e,a){return e&&_defineProperties(t.prototype,e),a&&_defineProperties(t,a),t}!function(t){function T(t,e){return t[e]<<8|t[e+1]}function A(t,e){var a=T(t,e);return a<32768?a:a-65536}var k=Symbol(),P={x:0,y:0,z:0,dx:0,dy:0,dz:0,m:[[0,0,0,0],[0,0,0,0],[0,0,0,0]],setup:function(t,e,a){this.dx=t[3],this.dy=t[4],this.dz=t[5];var r=Math,i=t[0]-e,s=t[1],o=t[2],n=t[6]/180*r.PI,c=t[7]/180*r.PI,l=t[8]/180*r.PI,h=r.cos(n),d=r.cos(c),f=r.cos(l),v=r.sin(n),u=r.sin(c),p=r.sin(l),b=this.m;b[0][0]=v*u*p+h*f,b[0][1]=p*d,b[0][2]=h*u*p-v*f,b[0][3]=this.dx+i,b[1][0]=v*u*f-p*h,b[1][1]=d*f,b[1][2]=h*u*f+v*p,b[1][3]=this.dy+s,b[2][0]=v*d,b[2][1]=-u,b[2][2]=h*d,b[2][3]=this.dz+o+a},convert:function(t,e,a){var r=t-this.dx,i=e-this.dy,s=a-this.dz,o=this.m;this.x=o[0][0]*r+o[0][1]*i+o[0][2]*s+o[0][3],this.y=o[1][0]*r+o[1][1]*i+o[1][2]*s+o[1][3],this.z=o[2][0]*r+o[2][1]*i+o[2][2]*s+o[2][3]}},I={x:0,y:0,z:0,m:[[0,0,0],[0,0,0],[0,0,0]],setup:function(t,e,a){var r=Math,i=e/180*r.PI*(a<0?-1:1),s=(a+90)/180*r.PI*(a<0?1:-1),o=t/180*r.PI,n=r.cos(i),c=r.cos(s),l=r.cos(o),h=r.sin(i),d=r.sin(s),f=r.sin(o),v=this.m;v[0][0]=-h*d*f+n*l,v[0][1]=-h*c,v[0][2]=h*d*l+n*f,v[1][0]=n*d*f+h*l,v[1][1]=n*c,v[1][2]=-n*d*l+h*f,v[2][0]=-c*f,v[2][1]=d,v[2][2]=c*l},convert:function(t,e,a){var r=this.m;this.x=r[0][0]*t+r[0][1]*e+r[0][2]*a,this.y=r[1][0]*t+r[1][1]*e+r[1][2]*a,this.z=r[2][0]*t+r[2][1]*e+r[2][2]*a}},e=function(){function s(t){_classCallCheck(this,s),this[k]={window:{x:0,y:0,w:0,h:0},orientation:{alpha:0,beta:0,gamma:-90,baseAlpha:void 0},depth:{minz:50,maxz:2e3},cext:!1,color:15,parameters:[0,0,0,0,0,0,0,0,0],data:{pct:0,vertices:new Int16Array(24576),lct:0,indices:new Uint16Array(16384),color:0},translate:{vertices:new Float32Array(24576),indices:new Float32Array(16384)},palette:[{r:0,g:0,b:0,c:"rgba(  0,   0,   0, 1.0)"},{r:85,g:85,b:85,c:"rgba( 85,  85,  85, 1.0)"},{r:0,g:0,b:127,c:"rgba(  0,   0, 127, 1.0)"},{r:0,g:0,b:255,c:"rgba(  0,   0, 255, 1.0)"},{r:127,g:0,b:0,c:"rgba(127,   0,   0, 1.0)"},{r:255,g:0,b:0,c:"rgba(255,   0,   0, 1.0)"},{r:127,g:0,b:127,c:"rgba(127,   0, 127, 1.0)"},{r:255,g:0,b:255,c:"rgba(255,   0, 255, 1.0)"},{r:0,g:127,b:0,c:"rgba(  0, 127,   0, 1.0)"},{r:0,g:255,b:0,c:"rgba(  0, 255,   0, 1.0)"},{r:0,g:127,b:127,c:"rgba(  0, 127, 127, 1.0)"},{r:0,g:255,b:255,c:"rgba(  0, 255, 255, 1.0)"},{r:127,g:127,b:0,c:"rgba(127, 127,   0, 1.0)"},{r:255,g:255,b:0,c:"rgba(255, 255,   0, 1.0)"},{r:170,g:170,b:170,c:"rgba(170, 170, 170, 1.0)"},{r:255,g:255,b:255,c:"rgba(255, 255, 255, 1.0)"}],contexts:t,fgcontext:0,bgcontext:1,clients:[],apage:0,vr:0,updatePalette:function(t){var e=this[k].palette[t];e.c="rgba("+e.r+","+e.g+","+e.b+",1.0)",e.l=.299*e.r+.587*e.g+.114*e.b|0,e.cl="rgba("+e.l+",0,0,1.0)",e.cr="rgba(0,0,"+e.l+",1.0)"}.bind(this),draw:function(t){var e=this[k].data.vertices,a=3*this[k].data.pct,r=this[k].translate.vertices;for(P.setup(this[k].parameters,t.position,this[k].depth.minz),o=0;o<a;o+=3)P.convert(e[o+0],e[o+1],e[o+2]),r[o+0]=P.x,r[o+1]=P.y,r[o+2]=P.z;if(this.vr()){var i=this[k].orientation;for(I.setup(i.alpha+t.alpha,i.beta,i.gamma),o=0;o<a;o+=3)I.convert(r[o+0],r[o+1],r[o+2]),r[o+0]=I.x,r[o+1]=I.y,r[o+2]=I.z}for(var s=this[k].depth.maxz+this[k].depth.minz,o=0;o<a;o+=3){var n,c=r[o+2];c<=0||s<c||(n=c/256,r[o+0]/=n,r[o+1]/=n)}var l=this[k].data.indices,h=2*this[k].data.lct,d=this[k].contexts[this[k].bgcontext];d.save(),d.beginPath(),d.rect(t.base,0,t.width,d.canvas.height),d.clip(),d.closePath(),d.beginPath(),d.strokeStyle=this[k].palette[this[k].data.color][t.color];var f=256*t.scaleX,v=256*t.scaleY,u=t.base+t.width/2,p=v/2,b=f/256,g=v/256;for(o=0;o<h;o+=2){var y=3*l[o+0],m=3*l[o+1],w=r[2+y],x=r[2+m];w<=0||s<w||x<=0||s<x||(d.moveTo(u+r[0+y]*b,p+r[1+y]*g),d.lineTo(u+r[0+m]*b,p+r[1+m]*g))}d.closePath(),d.stroke(),d.restore()}.bind(this)};var e=this[k].contexts[this[k].fgcontext];e.canvas.style.display="block",this[k].contexts[this[k].bgcontext].canvas.style.display="none";var a,r=_createForOfIteratorHelper(this[k].contexts);try{for(r.s();!(a=r.n()).done;){var i=a.value;i.clearRect(0,0,e.canvas.width,e.canvas.height),i.globalCompositeOperation="lighter"}}catch(t){r.e(t)}finally{r.f()}}return _createClass(s,[{key:"palette",value:function(t,e){if(null==e)return this[k].palette[t];var a=0==(1&e)?0:4,r=((e>>6&31)<<3)+a,i=((e>>11&31)<<3)+a,s=((e>>1&31)<<3)+a,o=this[k].palette[t];o.r=r,o.g=i,o.b=s,this[k].updatePalette(t)}},{key:"vr",value:function(t){if(void 0===t)return this[k].vr;var e=this[k].vr;this[k].vr=t;for(var a=0;a<16;++a)this[k].updatePalette(a);return e}},{key:"orientation",value:function(t,e,a){var r=this[k].orientation;void 0===r.baseAlpha&&(r.baseAlpha=t),r.alpha=t-r.baseAlpha,r.beta=e,r.gamma=a}},{key:"context",value:function(t){var e=1==this[k].vr,a=this[k].contexts[0].canvas,r=e&&2==t?a.width/2:0,i=e&&0!=t?a.width/2:a.width,s=e&&0!=t?1:4/3;return{color:2!=this[k].vr?"c":1==t?"cl":"cr",base:r,width:i,offset:r+(i-a.height*s)/2,position:0==t?0:1==t?-10:10,alpha:0==t?0:1==t?-2:2,aspect:s,scaleX:a.height/256*s,scaleY:a.height/256}}},{key:"vsync",value:function(t){this[k].clients.push(t)}},{key:"line",value:function(t,e){var a=this[k].contexts[this[k].apage],r=t.length;if(this[k].vr){var i=this.context(1);a.strokeStyle=this[k].palette[this[k].color][i.color],a.beginPath(),a.moveTo(t[0]*i.scaleX+i.offset,e[0]*i.scaleY);for(var s=1;s<r;++s)a.lineTo(t[s]*i.scaleX+i.offset,e[s]*i.scaleY);a.stroke();var o=this.context(2);a.strokeStyle=this[k].palette[this[k].color][o.color],a.beginPath(),a.moveTo(t[0]*o.scaleX+o.offset,e[0]*o.scaleY);for(var n=1;n<r;++n)a.lineTo(t[n]*o.scaleX+o.offset,e[n]*o.scaleY);a.stroke()}else{var c=this.context(0);a.strokeStyle=this[k].palette[this[k].color][c.color],a.beginPath(),a.moveTo(t[0]*c.scaleX+c.offset,e[0]*c.scaleY);for(var l=1;l<r;++l)a.lineTo(t[l]*c.scaleX+c.offset,e[l]*c.scaleY);a.stroke()}}},{key:"boxFull",value:function(t,e,a,r){var i,s,o,n=Math.min(t,a),c=Math.min(e,r),l=Math.abs(a-t),h=Math.abs(r-e),d=this[k].contexts[this[k].apage];this[k].vr?(i=this.context(1),d.fillStyle=this[k].palette[this[k].color][i.color],d.fillRect(n*i.scaleX+i.offset,c*i.scaleY,l*i.scaleX,h*i.scaleY),s=this.context(2),d.fillStyle=this[k].palette[this[k].color][s.color],d.fillRect(n*s.scaleX+s.offset,c*s.scaleY,l*s.scaleX,h*s.scaleY)):(o=this.context(0),d.fillStyle=this[k].palette[this[k].color][o.color],d.fillRect(n*o.scaleX+o.offset,c*o.scaleY,l*o.scaleX,h*o.scaleY))}},{key:"setWindow",value:function(t,e,a,r){this[k].window.x=t,this[k].window.y=e,this[k].window.w=a-t,this[k].window.h=r-e}},{key:"cls",value:function(){var t=this[k].contexts[this[k].apage];t.clearRect(0,0,t.canvas.width,t.canvas.height)}},{key:"set3dParameter",value:function(t,e){this[k].parameters[t]=e}},{key:"set3dData",value:function(t,e,a,r,i){this[k].data.pct=t,this[k].data.vertices=e,this[k].data.lct=a,this[k].data.indices=r,this[k].data.color=void 0!==i?i:this[k].color}},{key:"set3dRawData",value:function(t,e){var a=e;this[k].data.pct=T(t,e),e+=2;for(var r=0;r<this[k].data.pct;++r)this[k].data.vertices[3*r+0]=A(t,e+0),this[k].data.vertices[3*r+1]=A(t,e+2),this[k].data.vertices[3*r+2]=A(t,e+4),e+=6;this[k].data.lct=T(t,e),e+=2,this[k].cext?(this[k].data.color=15&T(t,e),e+=2):this[k].data.color=this[k].color;for(var i=0;i<this[k].data.lct;++i)this[k].data.indices[2*i+0]=T(t,e+0),this[k].data.indices[2*i+1]=T(t,e+2),e+=4;return e-a}},{key:"translate3dTo2d",value:function(){this[k].vr?(this[k].draw(this.context(1)),this[k].draw(this.context(2))):this[k].draw(this.context(0))}},{key:"display2d",value:function(){var t=this[k].fgcontext;this[k].fgcontext=this[k].bgcontext,this[k].bgcontext=t;var e=this[k].contexts[this[k].fgcontext],a=this[k].contexts[this[k].bgcontext];if(this[k].vr){var r,i=this.context(1),s=this.context(2),o=_createForOfIteratorHelper(this[k].clients);try{for(o.s();!(r=o.n()).done;){(c=r.value)(e,i),c(e,s)}}catch(t){o.e(t)}finally{o.f()}a.clearRect(0,0,a.canvas.width,a.canvas.height),a.fillStyle=this[k].palette[0][i.color],a.fillRect(0,0,a.canvas.width,a.canvas.height),a.fillStyle=this[k].palette[0][s.color],a.fillRect(0,0,a.canvas.width,a.canvas.height)}else{var n,c,l=this.context(0),h=_createForOfIteratorHelper(this[k].clients);try{for(h.s();!(n=h.n()).done;){(c=n.value)(e,l)}}catch(t){h.e(t)}finally{h.f()}a.clearRect(0,0,a.canvas.width,a.canvas.height),a.fillStyle=this[k].palette[0][l.color],a.fillRect(0,0,a.canvas.width,a.canvas.height)}e.canvas.style.display="block",a.canvas.style.display="none"}},{key:"color",value:function(t){this[k].color=t}},{key:"crt",value:function(t){console.warn("magic2: partially ignoring command CRT, "+t),this[k].cext=0!=(256&t)}},{key:"auto",value:function(t,e){for(var a=!1;;){var r=T(t,e);switch(e+=2,r){case 0:for(var i=T(t,e+0),s=[],o=[],n=0;n<i;++n)s.push(T(t,e+2+4*n)),o.push(T(t,e+4+4*n));e+=2+4*i,this.line(s,o);break;case 1:throw new Error("magic2: unsupported command SPLINE");case 2:throw e+=8,new Error("magic2: unsupported command BOX");case 3:throw new Error("magic2: unsupported command TRIANGLE");case 4:var c=T(t,e+0),l=T(t,e+2),h=T(t,e+4),d=T(t,e+6);e+=8,this.boxFull(c,l,h,d);break;case 5:throw new Error("magic2: unsupported command CIRCLE_FULL");case 6:var f=T(t,e+0),v=T(t,e+2),u=T(t,e+4),p=T(t,e+6);e+=8,this.setWindow(f,v,u,p);break;case 7:var b=T(t,e);e+=2,console.warn("magic2: ignoring command SET_MODE, "+b);break;case 8:throw new Error("magic2: unsupported command POINT");case 9:this.cls();break;case 11:var g=T(t,e+0),y=A(t,e+2);e+=4,this.set3dParameter(g,y);break;case 12:e+=this.set3dRawData(t,e);break;case 13:this.translate3dTo2d();break;case 14:this.display2d(),a=!0;break;case 15:return a;case 16:var m=T(t,e);e+=2,this.color(m);break;case 17:var w=T(t,e);e+=2,this.crt(w);break;case 18:break;case 19:throw new Error("magic2: AUTO should not be used inside AUTO");case 20:var x=T(t,e);e+=2,this.apage(x);break;case 21:var k=T(t,e+0),P=T(t,e+2);e+=4,this.depth(k,P);break;default:throw new Error("magic2: unknown command "+r)}}}},{key:"apage",value:function(t){this[k].apage=t}},{key:"depth",value:function(t,e){this[k].depth.minz=t,this[k].depth.maxz=e}}]),s}();t.Magic2=e}("undefined"!=typeof global?global:"undefined"!=typeof module?module.exports:window);