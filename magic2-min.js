"use strict";!function(t){const s=Symbol(),e=0,i=1,a=2,o=3,r=4,h=5,n=6,c=7,l=8,g=9,d=11,f=12,p=13,m=14,v=15,b=16,u=17,x=18,w=19,y=20,S=21,A=1,P=2,R=function(t,s){return t[s]<<8|t[s+1]},T=function(t,s){const e=R(t,s);return e<32768?e:e-65536},E={x:0,y:0,z:0,dx:0,dy:0,dz:0,m:[[0,0,0,0],[0,0,0,0],[0,0,0,0]],setup:function(t,s,e){this.dx=t[3],this.dy=t[4],this.dz=t[5];const i=Math,a=t[0]-s,o=t[1],r=t[2],h=t[6]/180*i.PI,n=t[7]/180*i.PI,c=t[8]/180*i.PI,l=i.cos(h),g=i.cos(n),d=i.cos(c),f=i.sin(h),p=i.sin(n),m=i.sin(c),v=this.m;v[0][0]=f*p*m+l*d,v[0][1]=m*g,v[0][2]=l*p*m-f*d,v[0][3]=this.dx+a,v[1][0]=f*p*d-m*l,v[1][1]=g*d,v[1][2]=l*p*d+f*m,v[1][3]=this.dy+o,v[2][0]=f*g,v[2][1]=-p,v[2][2]=l*g,v[2][3]=this.dz+r+e},convert:function(t,s,e){var i=t-this.dx,a=s-this.dy,o=e-this.dz,r=this.m;this.x=r[0][0]*i+r[0][1]*a+r[0][2]*o+r[0][3],this.y=r[1][0]*i+r[1][1]*a+r[1][2]*o+r[1][3],this.z=r[2][0]*i+r[2][1]*a+r[2][2]*o+r[2][3]}},C={x:0,y:0,z:0,m:[[0,0,0],[0,0,0],[0,0,0]],setup:function(t,s,e){const i=Math,a=s/180*i.PI*(e<0?-1:1),o=(e+90)/180*i.PI*(e<0?1:-1),r=t/180*i.PI,h=i.cos(a),n=i.cos(o),c=i.cos(r),l=i.sin(a),g=i.sin(o),d=i.sin(r),f=this.m;f[0][0]=-l*g*d+h*c,f[0][1]=-l*n,f[0][2]=l*g*c+h*d,f[1][0]=h*g*d+l*c,f[1][1]=h*n,f[1][2]=-h*g*c+l*d,f[2][0]=-n*d,f[2][1]=g,f[2][2]=n*c},convert:function(t,s,e){var i=this.m;this.x=i[0][0]*t+i[0][1]*s+i[0][2]*e,this.y=i[1][0]*t+i[1][1]*s+i[1][2]*e,this.z=i[2][0]*t+i[2][1]*s+i[2][2]*e}},L="\nprecision mediump float;\nattribute vec3 aCoord;\nattribute vec3 aColor;\nuniform mat4 uTMat;\nuniform mat4 uPMat;\nuniform vec3 uCamera;\nuniform float uContrast;\nvarying vec3 vColor;\n\nvoid main() {\n  gl_Position = uPMat * uTMat * vec4(aCoord - uCamera * 100., 1.0);\n  vColor = aColor * uContrast;\n}\n",I="\nprecision mediump float;\nvarying vec3 vColor;\n\nvoid main() {\n  gl_FragColor = vec4(vColor, 1.0);\n}\n";class F{constructor(){this.activated=!1,this.session=null,this.mainLoop=null,this.controllers=[],this.gl=null,this.space=null,this.views=[null,null],this.program=null,this.vbuffer=null,this.cbuffer=null,this.ibuffer=null,this.coords=new Float32Array(24576),this.colors=new Float32Array(24576),this.nCoords=0,this.indices=new Uint16Array(16384),this.nIndices=0}quit(){this.gl=null}async enter(t){if(this.mainLoop=t,this.activated)return;if(this.activated=!0,!navigator.xr)return;if(!await navigator.xr.isSessionSupported("immersive-vr"))return;if(this.session)return;this.session=await navigator.xr.requestSession("immersive-vr"),this.session.addEventListener("end",this.quit.bind(this),!1),this.session.addEventListener("inputsourceschange",t=>{for(let s of t.added)this.controllers=[s.gamepad].concat(this.controllers)}),navigator.getGamepads=(()=>this.controllers),this.gl=document.getElementById("xr").getContext("webgl",{xrCompatible:!0});const s=new XRWebGLLayer(this.session,this.gl);this.session.updateRenderState({baseLayer:s,depthFar:1e4}),this.space=await this.session.requestReferenceSpace("local");const e=this.gl.createShader(this.gl.VERTEX_SHADER);this.gl.shaderSource(e,L),this.gl.compileShader(e),this.gl.getShaderParameter(e,this.gl.COMPILE_STATUS)||console.error(this.gl.getShaderInfoLog(e,this.gl.COMPILE_STATUS));const i=this.gl.createShader(this.gl.FRAGMENT_SHADER);this.gl.shaderSource(i,I),this.gl.compileShader(i),this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS)||console.error(this.gl.getShaderInfoLog(i,this.gl.COMPILE_STATUS)),this.program=this.gl.createProgram(),this.gl.attachShader(this.program,e),this.gl.attachShader(this.program,i),this.gl.linkProgram(this.program),this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS)||console.error(this.gl.getProgramInfoLog(this.program)),this.vbuffer=this.gl.createBuffer(),this.cbuffer=this.gl.createBuffer(),this.ibuffer=this.gl.createBuffer();const a=(s,e)=>{if(this.session.requestAnimationFrame(a),!this.session.renderState.baseLayer)return;this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.session.renderState.baseLayer.framebuffer);const i=e.getViewerPose(this.space);let o=0;for(const t of i.views)this.views[o++]={port:this.session.renderState.baseLayer.getViewport(t),pmat:t.projectionMatrix,tmat:t.transform.inverse.matrix,pos:t.transform.position};t()};a(),this.activated||(this.activated=!0,this.leave())}async leave(){this.activated&&(this.activated=!1,this.session&&(await this.session.end(),this.session=null,this.activated&&(this.activated=!1,this.enter(this.mainLoop))))}display2d(t){if(!this.views[0])return;this.gl.clearColor(0,0,0,1),this.gl.clearDepth(1),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.gl.disable(this.gl.DEPTH_TEST),this.gl.useProgram(this.program),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.ibuffer),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,this.indices,this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vbuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.coords,this.gl.STATIC_DRAW);const s=this.gl.getAttribLocation(this.program,"aCoord");this.gl.vertexAttribPointer(s,3,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(s),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cbuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.colors,this.gl.STATIC_DRAW);const e=this.gl.getAttribLocation(this.program,"aColor");this.gl.vertexAttribPointer(e,3,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(e);for(const s of this.views){this.gl.viewport(s.port.x,s.port.y,s.port.width,s.port.height);const e=this.gl.getUniformLocation(this.program,"uPMat");this.gl.uniformMatrix4fv(e,!1,s.pmat);const i=this.gl.getUniformLocation(this.program,"uTMat");this.gl.uniformMatrix4fv(i,!1,s.tmat);const a=this.gl.getUniformLocation(this.program,"uCamera");this.gl.uniform3fv(a,[s.pos.x,s.pos.y,s.pos.z]);const o=this.gl.getUniformLocation(this.program,"uContrast");this.gl.uniform1f(o,t),this.gl.drawElements(this.gl.LINES,this.nIndices,this.gl.UNSIGNED_SHORT,0)}this.nCoords=0,this.nIndices=0,this.gl.flush()}draw(t,s,e,i){const a=t.vertices,o=3*t.pct;E.setup(s,0,e.minz);const r=this.nCoords,h=i[t.color].r/255,n=i[t.color].g/255,c=i[t.color].b/255;for(let t=0;t<o;t+=3)E.convert(a[t+0],a[t+1],a[t+2]),this.coords[3*this.nCoords+0]=E.x,this.coords[3*this.nCoords+1]=-E.y,this.coords[3*this.nCoords+2]=-E.z,this.colors[3*this.nCoords+0]=h,this.colors[3*this.nCoords+1]=n,this.colors[3*this.nCoords+2]=c,this.nCoords++;const l=t.indices,g=2*t.lct,d=e.maxz+e.minz;for(let t=0;t<g;t+=2){const s=r+l[t+0],e=r+l[t+1],i=-this.coords[3*s+2],a=-this.coords[3*e+2];i<0||d<i||a<0||d<a||(this.indices[this.nIndices++]=s,this.indices[this.nIndices++]=e)}}}t.Magic2=class{constructor(t){this[s]={window:{x:0,y:0,w:0,h:0},orientation:{alpha:0,beta:0,gamma:-90,baseAlpha:void 0},depth:{minz:50,maxz:2e3},cext:!1,color:15,contrast:1,parameters:[0,0,0,0,0,0,0,0,0],data:{pct:0,vertices:new Int16Array(24576),lct:0,indices:new Uint16Array(16384),color:0},translate:{vertices:new Float32Array(24576),indices:new Uint16Array(16384)},palette:[{r:0,g:0,b:0,c:"rgba(  0,   0,   0, 1.0)"},{r:85,g:85,b:85,c:"rgba( 85,  85,  85, 1.0)"},{r:0,g:0,b:127,c:"rgba(  0,   0, 127, 1.0)"},{r:0,g:0,b:255,c:"rgba(  0,   0, 255, 1.0)"},{r:127,g:0,b:0,c:"rgba(127,   0,   0, 1.0)"},{r:255,g:0,b:0,c:"rgba(255,   0,   0, 1.0)"},{r:127,g:0,b:127,c:"rgba(127,   0, 127, 1.0)"},{r:255,g:0,b:255,c:"rgba(255,   0, 255, 1.0)"},{r:0,g:127,b:0,c:"rgba(  0, 127,   0, 1.0)"},{r:0,g:255,b:0,c:"rgba(  0, 255,   0, 1.0)"},{r:0,g:127,b:127,c:"rgba(  0, 127, 127, 1.0)"},{r:0,g:255,b:255,c:"rgba(  0, 255, 255, 1.0)"},{r:127,g:127,b:0,c:"rgba(127, 127,   0, 1.0)"},{r:255,g:255,b:0,c:"rgba(255, 255,   0, 1.0)"},{r:170,g:170,b:170,c:"rgba(170, 170, 170, 1.0)"},{r:255,g:255,b:255,c:"rgba(255, 255, 255, 1.0)"}],contexts:t,fgcontext:0,bgcontext:1,clients:[],apage:0,vr:0,xr:new F,updatePalette:function(t){const e=this[s].palette[t];e.c="rgba("+e.r+","+e.g+","+e.b+",1.0)",e.l=.299*e.r+.587*e.g+.114*e.b|0,e.cl="rgba("+e.l+",0,0,1.0)",e.cr="rgba(0,0,"+e.l+",1.0)"}.bind(this),draw:function(t){var e,i=this[s].data.vertices,a=3*this[s].data.pct,o=this[s].translate.vertices;for(E.setup(this[s].parameters,t.position,this[s].depth.minz),e=0;e<a;e+=3)E.convert(i[e+0],i[e+1],i[e+2]),o[e+0]=E.x,o[e+1]=E.y,o[e+2]=E.z;if(this.vr()){var r=this[s].orientation;for(C.setup(r.alpha+t.alpha,r.beta,r.gamma),e=0;e<a;e+=3)C.convert(o[e+0],o[e+1],o[e+2]),o[e+0]=C.x,o[e+1]=C.y,o[e+2]=C.z}var h=this[s].depth.maxz+this[s].depth.minz;for(e=0;e<a;e+=3){var n=o[e+2];if(!(n<=0||h<n)){var c=n/256;o[e+0]/=c,o[e+1]/=c}}var l=this[s].data.indices,g=2*this[s].data.lct,d=this[s].contexts[this[s].bgcontext];d.save(),d.beginPath(),d.rect(t.base,0,t.width,d.canvas.height),d.clip(),d.closePath(),d.beginPath(),d.strokeStyle=this[s].palette[this[s].data.color][t.color];var f=256*t.scaleX,p=256*t.scaleY,m=t.base+t.width/2,v=p/2,b=f/256,u=p/256;for(e=0;e<g;e+=2){var x=3*l[e+0],w=3*l[e+1],y=o[x+2],S=o[w+2];y<=0||h<y||S<=0||h<S||(d.moveTo(m+o[x+0]*b,v+o[x+1]*u),d.lineTo(m+o[w+0]*b,v+o[w+1]*u))}d.closePath(),d.stroke(),d.restore()}.bind(this)};const e=this[s].contexts[this[s].fgcontext];e.canvas.style.display="block",this[s].contexts[this[s].bgcontext].canvas.style.display="none";for(let t of this[s].contexts)t&&(t.clearRect(0,0,e.canvas.width,e.canvas.height),t.globalCompositeOperation="lighter")}palette(t,e){if(void 0==e)return this[s].palette[t];var i=0==(1&e)?0:4,a=((e>>6&31)<<3)+i,o=((e>>11&31)<<3)+i,r=((e>>1&31)<<3)+i,h=this[s].palette[t];h.r=a,h.g=o,h.b=r,this[s].updatePalette(t)}xr(t,e){t?(this.vr(A),this[s].xr.enter(e)):this[s].xr.leave()}vr(t){var e=this[s].vr;if(void 0===t)return e;this[s].vr=t;for(let t=0;t<16;++t)this[s].updatePalette(t);return e}orientation(t,e,i){const a=this[s].orientation;void 0===a.baseAlpha&&(a.baseAlpha=t),a.alpha=t-a.baseAlpha,a.beta=e,a.gamma=i}context(t){const e=this[s].vr==A,i=this[s].contexts[0].canvas,a=e&&2==t?i.width/2:0,o=e&&0!=t?i.width/2:i.width,r=e&&0!=t?1:4/3;return{color:this[s].vr!=P?"c":1==t?"cl":"cr",base:a,width:o,offset:a+(o-i.height*r)/2,position:0==t?0:1==t?-10:10,alpha:0==t?0:1==t?-2:2,aspect:r,scaleX:i.height/256*r,scaleY:i.height/256}}vsync(t){this[s].clients.push(t)}line(t,e){const i=this[s].contexts[this[s].apage],a=t.length;if(this[s].xr.activated)console.log("line",t,e);else if(this[s].vr){const o=this.context(1);i.strokeStyle=this[s].palette[this[s].color][o.color],i.beginPath(),i.moveTo(t[0]*o.scaleX+o.offset,e[0]*o.scaleY);for(let s=1;s<a;++s)i.lineTo(t[s]*o.scaleX+o.offset,e[s]*o.scaleY);i.stroke();const r=this.context(2);i.strokeStyle=this[s].palette[this[s].color][r.color],i.beginPath(),i.moveTo(t[0]*r.scaleX+r.offset,e[0]*r.scaleY);for(let s=1;s<a;++s)i.lineTo(t[s]*r.scaleX+r.offset,e[s]*r.scaleY);i.stroke()}else{const o=this.context(0);i.strokeStyle=this[s].palette[this[s].color][o.color],i.beginPath(),i.moveTo(t[0]*o.scaleX+o.offset,e[0]*o.scaleY);for(let s=1;s<a;++s)i.lineTo(t[s]*o.scaleX+o.offset,e[s]*o.scaleY);i.stroke()}}boxFull(t,e,i,a){const o=Math.min(t,i),r=Math.min(e,a),h=Math.abs(i-t),n=Math.abs(a-e),c=this[s].contexts[this[s].apage];if(this[s].xr.activated)console.log("box",t,e,i,a);else if(this[s].vr){const t=this.context(1);c.fillStyle=this[s].palette[this[s].color][t.color],c.fillRect(o*t.scaleX+t.offset,r*t.scaleY,h*t.scaleX,n*t.scaleY);const e=this.context(2);c.fillStyle=this[s].palette[this[s].color][e.color],c.fillRect(o*e.scaleX+e.offset,r*e.scaleY,h*e.scaleX,n*e.scaleY)}else{const t=this.context(0);c.fillStyle=this[s].palette[this[s].color][t.color],c.fillRect(o*t.scaleX+t.offset,r*t.scaleY,h*t.scaleX,n*t.scaleY)}}setWindow(t,e,i,a){this[s].window.x=t,this[s].window.y=e,this[s].window.w=i-t,this[s].window.h=a-e}cls(){const t=this[s].contexts[this[s].apage];t.clearRect(0,0,t.canvas.width,t.canvas.height)}set3dParameter(t,e){this[s].parameters[t]=e}set3dData(t,e,i,a,o){this[s].data.pct=t,this[s].data.vertices=e,this[s].data.lct=i,this[s].data.indices=a,this[s].data.color=void 0!==o?o:this[s].color}set3dRawData(t,e){const i=e;this[s].data.pct=R(t,e),e+=2;for(let i=0;i<this[s].data.pct;++i)this[s].data.vertices[3*i+0]=T(t,e+0),this[s].data.vertices[3*i+1]=T(t,e+2),this[s].data.vertices[3*i+2]=T(t,e+4),e+=6;this[s].data.lct=R(t,e),e+=2,this[s].cext?(this[s].data.color=15&R(t,e),e+=2):this[s].data.color=this[s].color;for(let i=0;i<this[s].data.lct;++i)this[s].data.indices[2*i+0]=R(t,e+0),this[s].data.indices[2*i+1]=R(t,e+2),e+=4;return e-i}translate3dTo2d(){this[s].xr.activated?this[s].xr.draw(this[s].data,this[s].parameters,this[s].depth,this[s].palette):this[s].vr?(this[s].draw(this.context(1)),this[s].draw(this.context(2))):this[s].draw(this.context(0))}display2d(){if(this[s].xr.activated){const t=this[s].contexts[2],e=this.context(1),i=this.context(2);t.clearRect(0,0,t.canvas.width,t.canvas.height);for(let a of this[s].clients)a(t,[e,i]);return void this[s].xr.display2d(this[s].contrast)}const t=this[s].fgcontext;this[s].fgcontext=this[s].bgcontext,this[s].bgcontext=t;const e=this[s].contexts[this[s].fgcontext],i=this[s].contexts[this[s].bgcontext];if(this[s].vr){var a=this.context(1),o=this.context(2);for(var r of this[s].clients)r(e,[a,o]);i.clearRect(0,0,i.canvas.width,i.canvas.height),i.fillStyle=this[s].palette[0][a.color],i.fillRect(0,0,i.canvas.width,i.canvas.height),i.fillStyle=this[s].palette[0][o.color],i.fillRect(0,0,i.canvas.width,i.canvas.height)}else{var h=this.context(0);for(var r of this[s].clients)r(e,[h]);i.clearRect(0,0,i.canvas.width,i.canvas.height),i.fillStyle=this[s].palette[0][h.color],i.fillRect(0,0,i.canvas.width,i.canvas.height)}e.canvas.style.display="block",i.canvas.style.display="none"}color(t){this[s].color=t}crt(t){console.warn("magic2: partially ignoring command CRT, "+t),this[s].cext=0!=(256&t)}auto(t,s){let A=!1;for(;;){var P=R(t,s);switch(s+=2,P){case e:{const e=R(t,s+0),i=[],a=[];for(let o=0;o<e;++o)i.push(R(t,s+2+4*o)),a.push(R(t,s+4+4*o));s+=2+4*e,this.line(i,a);break}case i:throw new Error("magic2: unsupported command SPLINE");case a:throw s+=8,new Error("magic2: unsupported command BOX");case o:throw new Error("magic2: unsupported command TRIANGLE");case r:{const e=R(t,s+0),i=R(t,s+2),a=R(t,s+4),o=R(t,s+6);s+=8,this.boxFull(e,i,a,o);break}case h:throw new Error("magic2: unsupported command CIRCLE_FULL");case n:{const e=R(t,s+0),i=R(t,s+2),a=R(t,s+4),o=R(t,s+6);s+=8,this.setWindow(e,i,a,o);break}case c:{const e=R(t,s);s+=2,console.warn("magic2: ignoring command SET_MODE, "+e);break}case l:throw new Error("magic2: unsupported command POINT");case g:this.cls();break;case d:{const e=R(t,s+0),i=T(t,s+2);s+=4,this.set3dParameter(e,i);break}case f:s+=this.set3dRawData(t,s);break;case p:this.translate3dTo2d();break;case m:this.display2d(),A=!0;break;case v:return A;case b:{const e=R(t,s);s+=2,this.color(e);break}case u:{const e=R(t,s);s+=2,this.crt(e);break}case x:break;case w:throw new Error("magic2: AUTO should not be used inside AUTO");case y:{const e=R(t,s);s+=2,this.apage(e);break}case S:{const e=R(t,s+0),i=R(t,s+2);s+=4,this.depth(e,i);break}default:throw new Error("magic2: unknown command "+P)}}}apage(t){this[s].apage=t}depth(t,e){this[s].depth.minz=t,this[s].depth.maxz=e}contrast(t){this[s].contrast=t/15;for(let t=0;t<3;++t){let e=this[s].contexts[t];e&&(e.canvas.style.opacity=this[s].contrast)}}point3d(t,e,i,a){if(this[s].xr.activated);else if(this[s].vr){const o=this[s].contexts[this[s].fgcontext],r=this.context(1),h=this[s].orientation;C.setup(h.alpha+r.alpha,h.beta,h.gamma),C.convert(t,e,i);const n=C.z/256,c=r.offset+C.x/n*r.scaleX;c<r.width&&(o.beginPath(),o.arc(c,C.y/n*r.scaleY,a*r.scaleY,0,2*Math.PI),o.fillStyle=this[s].palette[15][r.color],o.fill(),o.closePath());const l=this.context(2);C.setup(h.alpha+l.alpha,h.beta,h.gamma),C.convert(t,e,i);const g=C.z/256,d=l.offset+C.x/g*l.scaleX;l.base<d&&(o.beginPath(),o.arc(d,C.y/g*l.scaleY,a*l.scaleY,0,2*Math.PI),o.fillStyle=this[s].palette[15][l.color],o.fill(),o.closePath())}else{const o=this[s].contexts[this[s].fgcontext],r=this.context(0),h=i/256;o.beginPath(),o.arc(r.offset+t/h*r.scaleX,e/h*r.scaleY,a*r.scaleY,0,2*Math.PI),o.fillStyle=this[s].palette[15][r.color],o.fill(),o.closePath()}}}}("undefined"!=typeof global?global:"undefined"!=typeof module?module.exports:window);